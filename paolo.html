<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sellmasters - Riepilogo delle vendite</title>

    <!-- vue js -->
    <script src="https://unpkg.com/vue@next"></script>
    <script src="https://unpkg.com/vue-router@4"></script>

    <!-- Bootstrap 5 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
      crossorigin="anonymous"
    ></script>

    <style>
      .scrollmenu {
        overflow-x: auto;
        white-space: nowrap;
      }

      .scrollmenu a {
        display: inline-block;
        text-decoration: none;
      }
    </style>
  </head>

  <body>
    <div id="app"></div>
    <script>
      const app = {
        /*html*/
        template: `
              <div class="col-lg-8 mx-auto p-3 py-md-5">
                <header class="d-flex align-items-center pb-3 mb-5 border-bottom">
                  <p class="d-flex align-items-center text-dark text-decoration-none">
                    <img src="img/sellmasters_logo.png" alt="Sellmasters" style="max-height: 40px">
                    <span class="fs-4 mx-1">Esportazione delle vendite</span>
                  </p>
                </header>

                <main>
                <form action="" method="get" @submit.prevent="retrieve_data()">
                    <div class="form-floating my-3">
                      <select class="form-select" id="merchant" v-model="selected_merchant" required>
                        <option selected disabled></option>
                        <option
                        v-for="(merchant, key) in merchants"
                        :key="key"
                        :value="key"
                      >
                          {{merchant.name}}
                        </option>

                      </select>
                      <label for="merchant">Seleziona un cliente</label>
                    </div>

                    <div class="form-floating mb-3">
                      <input type="date" class="form-control" id="date_min" v-model="data_min">
                      <label for="date_min">Data inizio</label>
                    </div>

                    <div class="form-floating mb-3">
                      <input type="date" class="form-control" id="date_max" v-model="data_max">
                      <label for="date_min">Data fine</label>
                    </div>

                    <div class="mb-5">
                      <input type="submit" class="btn btn-primary btn-lg px-4" value="Scarica file">
                    </div>
                  </form>
                  <div class="d-flex align-items-center" v-if="loading">
                    <strong>Loading...</strong>
                    <div class="spinner-border ms-auto" role="status" aria-hidden="true"></div>
                  </div>
                  <div class="alert alert-danger" role="alert" v-if="error_message">
                    {{ error_message }}
                  </div>
                </main>
                <footer class="pt-5 my-5 text-muted border-top">
                  Sellmasters &middot; &copy; 2022
                </footer>
              </div>
              `,
        data() {
          return {
            merchants: [
              {
                name: "Etape - Shopify",
                value: "etape",
                link: "../sellmasters_script_api_cms/repositories/retrieve_orders_shopify.php?",
              },
              {
                name: "Francavilla - Shopify",
                value: "francavilla",
                link: "../sellmasters_script_api_cms/repositories/retrieve_orders_shopify.php?",
              },
              {
                name: "Old England - Shopify",
                value: "oldengland",
                link: "../sellmasters_script_api_cms/repositories/retrieve_orders_shopify.php?",
              },
              {
                name: "Sellmasters - Shopify",
                value: "sellmasters",
                link: "../sellmasters_script_api_cms/repositories/retrieve_orders_shopify.php?",
              },
              {
                name: "Studioarch - Prestashop",
                value: "studioarch",
                link: "../sellmasters_script_api_cms/studioarch/retrieve_orders_prestashop.php?",
              },
              {
                name: "Maracana - Prestashop",
                value: "maracana",
                link: "../sellmasters_script_api_cms/maracana/retrieve_orders_prestashop.php?",
              },
              {
                name: "Divesamente Enoteca - WooCommerce",
                value: "maracana",
                link: "../sellmasters_script_api_cms/diversamente_enoteca/retrieve_orders_woocommerce.php?",
              },
            ],
            selected_merchant: null,
            data_min: null,
            data_max: null,
            retrieved_orders_data: null,
            loading: false,
            error_message: null,
            timeout_id: null,
          };
        },
        methods: {
          retrieve_data() {
            this.loading = true;
            clearTimeout(this.timeout_id);
            this.error_message = null;
            fetch(
              this.merchant_link +
                "merchant=" +
                this.merchant +
                "&date_min=" +
                this.data_min +
                "&date_max=" +
                this.data_max +
                "&format=paolo",
              {
                method: "GET",
              }
            )
              .then((response) => response.json())
              .then((result) => {
                let csvFileData = "";
                for (const [key, row] of Object.entries(result.data)) {
                  // set the csv header
                  if (key == 0) {
                    for (const [index, value] of Object.entries(row)) {
                      csvFileData += index + ";";
                    }
                    csvFileData += "\n";
                  }
                  // get the row's data
                  for (const [index, value] of Object.entries(row)) {
                    if (index == "ordine_marketplace") {
                      csvFileData += value.replace("#", "") + ";";
                    } else {
                      csvFileData += value + ";";
                    }
                  }
                  csvFileData += "\n";
                }

                let hiddenElement = document.createElement("a");
                hiddenElement.href =
                  "data:text/csv;charset=utf-8," + encodeURI(csvFileData);
                hiddenElement.target = "_blank";
                // provide the name for the CSV file to be downloaded
                hiddenElement.download =
                  this.merchant +
                  " - dal " +
                  this.data_min +
                  " al " +
                  this.data_max +
                  ".csv";
                hiddenElement.click();
                this.loading = false;
              })
              .catch((error) => {
                this.error_message = "Nella tua ricerca non risulta ordini.";
                this.loading = false;
                this.timeout_id = setTimeout(() => {
                  this.error_message = null;
                }, 3000);
              });
          },
        },
        computed: {
          merchant() {
            return this.merchants[this.selected_merchant].value;
          },
          merchant_link() {
            return this.merchants[this.selected_merchant].link;
          },
        },
        beforeMount() {},
      };

      // instance of Vue Js
      Vue.createApp(app).mount("#app");
    </script>
  </body>
</html>
